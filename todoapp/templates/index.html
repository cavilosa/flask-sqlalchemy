<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title>Todo App</title>
    </head>
    <style media="screen">
        .hidden {
            display: none;
        }
        ul {
            list-style: none;
            width: 300px;
            display: inline-block;
        }
        li {
            clear: both;
        }
        li button {
          -webkit-appearance: none;
          border: none;
          outline: none;
          color: red;
          float: right;
          cursor: pointer;
          font-size: 20px;
        }

        .items {
            display: flex;
            flex-flow: row;
            justify-content: space-around;
        }

        input {
            max-width: 100px;
        }

    </style>
    <body>
        <h1>Todo App</h1>
        <div id="error" class="hidden">
            Something went wrong!
        </div>
        <div class="items">
            <div class="lists-wrapper">
                <h2>TODO LISTS</h2>
                <div class="create-list">
                    <form id="create-list">
                        <div class="create-list">
                            <label for="create_list">Create list</label>
                            <input type="text" id="list-name" value="A new List">
                            <input type="submit" name="submit" value="Create List">

                        </div>
                    </form>
                </div>

                <ul id="lists">
                    {% for list in lists %}
                    <li>
                        <input type="checkbox" class="check-completed"
                            data-id = "{{ list.id }}">
                        <a href="/lists/{{ list.id }}">{{ list.name }}</a>
                        <button type="button" id="delete" name = "button"
                            data-id = {{ list.id }}>&cross;</button>
                    </li>

                    {% endfor %}
                </ul>
            </div>

            <div class="todos-wrapper">
                <h2>TODO ITEMS</h2>
                <h4> {{ active_list.name }}</h4>
                <form id="form">
                    <div >
                        <label for="todo">Create Task</label>
                        <input type="text" id="description"
                            name="Task description">
                        <input type="submit" name="submit" id="submit" value="Create">
                    </div>
                </form>

                <ul id="todos">
                    {% for todo in todos %}
                    <li>
                        <input class="check-completed" data-id = "{{ todo.id }}"
                            type="checkbox" {% if todo.completed %} checked {% endif %} />
                            <!-- checked here equals to true in the table -->
                        {{ todo.description }}
                        <button type="button" id="delete" data-id = "{{ todo.id }}"
                            name="button">&cross;</button>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

    <script type="text/javascript">

        const deleteButtons = document.querySelectorAll("#delete");

        for (let i = 0; i < deleteButtons.length; i++) {
            const deleteButton = deleteButtons[i];
            deleteButton.addEventListener("click", (e)=>{
                e.preventDefault();
                console.log("delete event", e);
                const deleteId = e.target.dataset["id"];
                fetch ("/todos/" + deleteId + "/delete", {
                    method: "POST"
                })
                .then( () => {
                    document.querySelector("#error").className = "hidden";
                })
                .catch( (error)=> {
                     console.log(error)
                     document.querySelector("#error").className = "";
                })
            })
        }


        const checkboxes = document.querySelectorAll(".check-completed");
        for (let i = 0; i < checkboxes.length; i++) {
            const checkbox = checkboxes[i];
            checkbox.onchange = function(e){
                console.log("event", e);
                const todoId = e.target.dataset["id"];
                const newCompleted = e.target.checked; // sets check to true
                fetch ("/todos/" + todoId + "/set-completed", {
                    method: "POST",
                    body: JSON.stringify( {
                        'completed': newCompleted // may be can be just True?
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then( () => {
                    document.querySelector("#error").className = "hidden";
                })
                .catch( (error)=> {
                     console.log(error)
                     document.querySelector("#error").className = "";
                })
            }
        }

        document.querySelector("#form").onsubmit = function(e) {
           e.preventDefault(); //so the page doesn't reload
           const description = document.querySelector("#description").value;
           if (description === ""){
                document.querySelector("#error").className = "";
                const error = document.querySelector("#error")
                error.innerHTML = "The filed should be not empty"
           } else {
               fetch("/todos/create", {
                   method: "POST",
                   body: JSON.stringify(
                       {"description": description}
                   ),
                   headers: {
                       "Content-Type": "application/json"
                   }
               })
               .then( (response) => {
                    return response.json();
               })
               .then( (jsonResponse) => {
                   console.log("jsonresponse", jsonResponse);
                   const liItem = document.createElement("LI");
                   liItem.innerHTML = jsonResponse["description"];
                   document.querySelector("#todos").appendChild(liItem);
               })
               .catch( (error)=> {
                    console.log(error)
                    document.querySelector("#error").className = "";
               })
           }

            // dovument.querySelector("#create-list").onsubmit = function(e) {
            //     e.preventDefault();
            //     console.log("submit list", e)
            //     const newList = document.querySelector("#list-name").value;
            //     if (value === "") {
            //         const error =  document.querySelector("#error")
            //         error.className = "";
            //         error.innerHTML = "List name can't be empty"
            //     } else {
            //         fetch("/lists/create" + newList, {
            //             method: "POST",
            //             body: JSON.stringify({
            //                 "name": newList
            //             }),
            //             headers: {
            //                 "Content-Type":"application/json"
            //             }
            //         })
            //         .then( (response) => {
            //             return response.json();
            //         })
            //         .then( (resJson) => {
            //             console.log("list resjson", resJson);
            //             const listItem = document.createElement("LI")
            //             listItem.innerHTML = resJson["name"];
            //             document.querySelector("#lists").appendChild(listItem);
            //         })
            //         .catch( (error)=> {
            //              console.log(error)
            //              document.querySelector("#error").className = "";
            //         })
            //     }
            // }

        }
    </script>
    </body>
</html>
